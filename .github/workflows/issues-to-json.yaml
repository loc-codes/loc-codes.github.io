name: Update Daily Planner JSON

permissions:
  issues: read
  contents: write

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # daily midnight AU time
  issues:
    types: [opened]

jobs:
  generate-json:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch all issues from workday-planner
        id: get-issues
        uses: actions/github-script@v5
        with:
          script: |
            const fs = require('fs');
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              per_page: 100,
              sort: 'created',
              direction: 'desc'
            });
            const issueData = issues.data.map(issue => ({
              title: issue.title,
              url: issue.html_url
            }));
            fs.writeFileSync('issue-titles.json', JSON.stringify(issueData, null, 2));

      - name: Push to loc-codes.github.io
        env:
          PAGES_REPO: loc-codes/loc-codes.github.io
          PAGES_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # clone Pages repo
          git clone https://x-access-token:${GITHUB_TOKEN}@github.com/${PAGES_REPO}.git pages
          cd pages

          # copy JSON and index.html from workday-planner
          cp ../issue-titles.json ./issue-titles.json
          cp ../index.html ./index.html

          git add -A
          git commit -m "Update JSON and index.html" || echo "No changes to commit"
          git push origin ${PAGES_BRANCH}
